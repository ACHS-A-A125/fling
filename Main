local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local localPlayer = Players.LocalPlayer
local velocityMultiplier = 10000
local forceCFrameEachStep = true

local hrp, char
local conn
local flingActive = true  -- controls whether fling should run

-- Get local HumanoidRootPart safely
local function getLocalHRP()
    local chr = localPlayer.Character or localPlayer.CharacterAdded:Wait()
    local root = chr:WaitForChild("HumanoidRootPart", 5) or chr:FindFirstChild("Torso")
    return root, chr
end

-- Start fling loop
local function startFling()
    if conn then conn:Disconnect() end
    if not hrp or not hrp.Parent then return end

    conn = RunService.Heartbeat:Connect(function()
        if not flingActive then
            conn:Disconnect()
            conn = nil
            return
        end

        local targetPlayer = Players:FindFirstChild(_G.targetPlayerName)
        if not targetPlayer or not targetPlayer.Character then return end

        local targetHRP = targetPlayer.Character:FindFirstChild("HumanoidRootPart") 
                        or targetPlayer.Character:FindFirstChild("Torso")
        if not targetHRP then return end

        local toTarget = targetHRP.Position - hrp.Position
        local direction = (toTarget.Magnitude > 0.0001) and toTarget.Unit or Vector3.new(0,0,0)

        pcall(function()
            if hrp:IsA("BasePart") then
                hrp.AssemblyLinearVelocity = direction * velocityMultiplier
            else
                hrp.Velocity = direction * velocityMultiplier
            end
        end)

        if forceCFrameEachStep then
            local lookVec = hrp.CFrame.LookVector
            hrp.CFrame = CFrame.new(targetHRP.Position, targetHRP.Position + lookVec)
        end
    end)
end

-- Stop fling safely
local function stopFling()
    flingActive = false
    if conn then
        conn:Disconnect()
        conn = nil
    end
end

-- Initialize character and start fling
local function setupCharacter(character)
    hrp, char = getLocalHRP()
    if not hrp then return end

    local humanoid = char:FindFirstChildWhichIsA("Humanoid")
    if humanoid then
        pcall(function()
            humanoid.PlatformStand = false
            humanoid:ChangeState(Enum.HumanoidStateType.GettingUp)
        end)

        -- Stop fling permanently when humanoid dies
        humanoid.Died:Connect(function()
            stopFling()
        end)
    end

    startFling()
end

-- Only setup fling for current character
if localPlayer.Character then
    setupCharacter(localPlayer.Character)
end

print("[extreme-fling] active. Targeting player:", _G.targetPlayerName)
