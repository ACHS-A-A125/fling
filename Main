local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local localPlayer = Players.LocalPlayer

local velocityMultiplier = 25000
local forceCFrameEachStep = true

local hrp, char
local conn
local flingActive = true

-- Get HRP safely
local function getLocalHRP()
	local chr = localPlayer.Character or localPlayer.CharacterAdded:Wait()
	local root = chr:WaitForChild("HumanoidRootPart", 10) or chr:FindFirstChild("Torso")
	return root, chr
end

-- Stop fling safely
local function stopFling()
	flingActive = false
	if conn then
		conn:Disconnect()
		conn = nil
	end
end

-- Start fling loop
local function startFling(targetPlayer)
	if conn then conn:Disconnect() end
	if not hrp or not hrp.Parent then return end
	if not targetPlayer or not targetPlayer.Character then return end

	flingActive = true
	local targetHRP = targetPlayer.Character:FindFirstChild("HumanoidRootPart") or targetPlayer.Character:FindFirstChild("Torso")
	if not targetHRP then return end

	-- Stop fling when target dies
	local targetHumanoid = targetPlayer.Character:FindFirstChildWhichIsA("Humanoid")
	if targetHumanoid then
		targetHumanoid.Died:Connect(function()
			print("[fling] Target died, stopping fling.")
			stopFling()
		end)
	end

	conn = RunService.Heartbeat:Connect(function()
		if not flingActive then return end
		if not targetHRP or not targetHRP.Parent then
			stopFling()
			return
		end

		local toTarget = targetHRP.Position - hrp.Position
		if toTarget.Magnitude == 0 then return end

		local flingVector = toTarget.Unit * velocityMultiplier

		pcall(function()
			if hrp:IsA("BasePart") then
				hrp.AssemblyLinearVelocity = flingVector
			end
		end)

		-- Optionally face the target
		if forceCFrameEachStep then
			hrp.CFrame = CFrame.lookAt(hrp.Position, targetHRP.Position)
		end
	end)
end

-- Character setup
local function setupCharacter(character)
	hrp, char = getLocalHRP()
	if not hrp then return end

	local humanoid = char:FindFirstChildWhichIsA("Humanoid")
	if humanoid then
		humanoid.Died:Connect(function()
			print("[fling] You died, stopping fling.")
			stopFling()
		end)
	end

	local targetPlayer = Players:FindFirstChild(_G.targetPlayerName)
	if targetPlayer then
		startFling(targetPlayer)
	else
		warn("[fling] No target found:", _G.targetPlayerName)
	end
end

-- Handle respawn
localPlayer.CharacterAdded:Connect(function(char)
	task.wait(1)
	setupCharacter(char)
end)

if localPlayer.Character then
	setupCharacter(localPlayer.Character)
end

print("[fling] active. Targeting:", _G.targetPlayerName)
