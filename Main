local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local localPlayer = Players.LocalPlayer

local velocityMultiplier = 25000
local orbitRadius = 1
local orbitSpeed = 50
local verticalOffset = 2
local forceCFrameEachStep = true

local hrp, char
local conn
local flingActive = false
local stoppedPermanently = false

-- Stop fling safely
local function stopFling()
	flingActive = false
	stoppedPermanently = true
	if conn then
		conn:Disconnect()
		conn = nil
	end
	hrp = nil
	char = nil
end

-- Get HRP safely
local function getLocalHRP(character)
	local root = character:WaitForChild("HumanoidRootPart", 10) or character:FindFirstChild("Torso")
	return root
end

-- Start fling loop
local function startFling(targetPlayer)
	if stoppedPermanently then return end
	if conn then conn:Disconnect() end

	hrp = getLocalHRP(localPlayer.Character)
	char = localPlayer.Character
	if not hrp or not targetPlayer or not targetPlayer.Character then return end

	local targetHRP = targetPlayer.Character:FindFirstChild("HumanoidRootPart") or targetPlayer.Character:FindFirstChild("Torso")
	if not targetHRP then return end

	flingActive = true

	-- Stop fling when target dies
	local targetHumanoid = targetPlayer.Character:FindFirstChildWhichIsA("Humanoid")
	if targetHumanoid then
		targetHumanoid.Died:Connect(function()
			print("[orbit-fling] Target died, stopping fling.")
			stopFling()
		end)
	end

	conn = RunService.Heartbeat:Connect(function(dt)
		if not flingActive or not hrp or not hrp.Parent then return end
		if not targetHRP or not targetHRP.Parent then
			stopFling()
			return
		end

		local t = tick() * orbitSpeed
		local orbitX = math.cos(t) * orbitRadius
		local orbitZ = math.sin(t) * orbitRadius
		local orbitPos = targetHRP.Position + Vector3.new(orbitX, verticalOffset, orbitZ)

		local toTarget = (targetHRP.Position - hrp.Position)
		if toTarget.Magnitude == 0 then return end
		local direction = toTarget.Unit
		local flingVector = direction * velocityMultiplier

		pcall(function()
			if hrp:IsA("BasePart") then
				hrp.AssemblyLinearVelocity = flingVector
			end
		end)

		if forceCFrameEachStep then
			hrp.CFrame = CFrame.lookAt(orbitPos, targetHRP.Position)
		else
			hrp.CFrame = CFrame.new(orbitPos)
		end
	end)
end

-- Character setup
local function setupCharacter(character)
	if stoppedPermanently then return end
	hrp = getLocalHRP(character)
	char = character

	local humanoid = character:FindFirstChildWhichIsA("Humanoid")
	if humanoid then
		humanoid.Died:Connect(function()
			print("[orbit-fling] You died, stopping fling permanently.")
			stopFling()
		end)
	end

	local targetPlayer = Players:FindFirstChild(_G.targetPlayerName)
	if targetPlayer then
		startFling(targetPlayer)
	end
end

-- Handle respawn
localPlayer.CharacterAdded:Connect(function(char)
	task.wait(0.5)
	if stoppedPermanently then return end
	setupCharacter(char)
end)

if localPlayer.Character then
	setupCharacter(localPlayer.Character)
end

print("[orbit-fling] active. Targeting:", _G.targetPlayerName)
