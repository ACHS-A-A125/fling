local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local localPlayer = Players.LocalPlayer
local velocityMultiplier = 8000 -- lowered to stabilize
local forceCFrameEachStep = true
local flingRange = 40 -- max distance before it stops pushing
local minDistance = 2 -- stay close enough to the target

local hrp, char
local conn
local flingActive = true

-- Get local HumanoidRootPart safely
local function getLocalHRP()
	local chr = localPlayer.Character or localPlayer.CharacterAdded:Wait()
	local root = chr:WaitForChild("HumanoidRootPart", 5) or chr:FindFirstChild("Torso")
	return root, chr
end

-- Start fling loop
local function startFling()
	if conn then conn:Disconnect() end
	if not hrp or not hrp.Parent then return end

	conn = RunService.Heartbeat:Connect(function()
		if not flingActive then
			conn:Disconnect()
			conn = nil
			return
		end

		local targetPlayer = Players:FindFirstChild(_G.targetPlayerName)
		if not targetPlayer or not targetPlayer.Character then return end

		local targetHRP = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
			or targetPlayer.Character:FindFirstChild("Torso")
		if not targetHRP then return end

		local toTarget = targetHRP.Position - hrp.Position
		local dist = toTarget.Magnitude

		if dist > flingRange then
			-- Too far, don’t fling — teleport closer instead
			hrp.CFrame = CFrame.new(targetHRP.Position + Vector3.new(0, 5, 0))
			return
		end

		local direction = (dist > 0.001) and toTarget.Unit or Vector3.new(0, 0, 0)

		-- Adjust velocity strength based on proximity (stronger when close)
		local adjustedVelocity = velocityMultiplier * math.clamp(1 - (dist / flingRange), 0.2, 1)

		pcall(function()
			if hrp:IsA("BasePart") then
				hrp.AssemblyLinearVelocity = direction * adjustedVelocity
			else
				hrp.Velocity = direction * adjustedVelocity
			end
		end)

		-- Keep facing target for consistent fling direction
		if forceCFrameEachStep then
			hrp.CFrame = CFrame.lookAt(hrp.Position, targetHRP.Position)
		end
	end)
end

-- Stop fling safely
local function stopFling()
	flingActive = false
	if conn then
		conn:Disconnect()
		conn = nil
	end
end

-- Initialize character and start fling
local function setupCharacter(character)
	hrp, char = getLocalHRP()
	if not hrp then return end

	local humanoid = char:FindFirstChildWhichIsA("Humanoid")
	if humanoid then
		pcall(function()
			humanoid.PlatformStand = false
			humanoid:ChangeState(Enum.HumanoidStateType.GettingUp)
		end)

		humanoid.Died:Connect(stopFling)
	end

	startFling()
end

-- Only setup fling for current character
if localPlayer.Character then
	setupCharacter(localPlayer.Character)
end

print("[improved-fling] active. Targeting player:", _G.targetPlayerName)
