local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local localPlayer = Players.LocalPlayer

local velocityMultiplier = 25000
local orbitRadius = 8
local orbitSpeed = 20
local verticalOffset = 2
local forceCFrameEachStep = true

local hrp, char
local conn
local flingActive = true

-- Get HRP safely
local function getLocalHRP()
	local chr = localPlayer.Character or localPlayer.CharacterAdded:Wait()
	local root = chr:WaitForChild("HumanoidRootPart", 10) or chr:FindFirstChild("Torso")
	return root, chr
end

-- Stop fling safely
local function stopFling()
	flingActive = false
	if conn then
		conn:Disconnect()
		conn = nil
	end
end

-- Start fling loop
local function startFling(targetPlayer)
	if conn then conn:Disconnect() end
	if not hrp or not hrp.Parent then return end
	if not targetPlayer or not targetPlayer.Character then return end

	flingActive = true
	local targetHRP = targetPlayer.Character:FindFirstChild("HumanoidRootPart") or targetPlayer.Character:FindFirstChild("Torso")
	if not targetHRP then return end

	-- Stop fling when target dies
	local targetHumanoid = targetPlayer.Character:FindFirstChildWhichIsA("Humanoid")
	if targetHumanoid then
		targetHumanoid.Died:Connect(function()
			print("[orbit-fling] Target died, stopping fling.")
			stopFling()
		end)
	end

	local t = 0
	conn = RunService.Heartbeat:Connect(function(dt)
		if not flingActive then return end
		if not targetHRP or not targetHRP.Parent then
			stopFling()
			return
		end

		t += dt * orbitSpeed

		local orbitX = math.cos(t) * orbitRadius
		local orbitZ = math.sin(t) * orbitRadius
		local orbitPos = targetHRP.Position + Vector3.new(orbitX, verticalOffset, orbitZ)

		local toTarget = targetHRP.Position - hrp.Position
		if toTarget.Magnitude == 0 then return end
		local direction = toTarget.Unit
		local flingVector = direction * velocityMultiplier

		pcall(function()
			if hrp:IsA("BasePart") then
				hrp.AssemblyLinearVelocity = flingVector
			end
		end)

		if forceCFrameEachStep then
			-- Lying down orientation
			local lookVector = targetHRP.Position - orbitPos
			if lookVector.Magnitude ~= 0 then
				local lookUnit = lookVector.Unit
				local upVector = Vector3.new(0,0,-1)
				hrp.CFrame = CFrame.fromMatrix(orbitPos, lookUnit, upVector)
			end
		else
			-- Optional upright version
			hrp.CFrame = CFrame.new(orbitPos) * CFrame.Angles(math.rad(90), 0, 0)
		end
	end)
end

-- Character setup
local function setupCharacter(character)
	hrp, char = getLocalHRP()
	if not hrp then return end

	local humanoid = char:FindFirstChildWhichIsA("Humanoid")
	if humanoid then
		humanoid.Died:Connect(function()
			print("[orbit-fling] You died, stopping fling.")
			stopFling()
		end)
	end

	local targetPlayer = Players:FindFirstChild(_G.targetPlayerName)
	if targetPlayer then
		startFling(targetPlayer)
	else
		warn("[orbit-fling] No target found:", _G.targetPlayerName)
	end
end

-- Handle respawn
localPlayer.CharacterAdded:Connect(function(char)
	task.wait(1)
	setupCharacter(char)
end)

if localPlayer.Character then
	setupCharacter(localPlayer.Character)
end

print("[orbit-fling] active. Targeting:", _G.targetPlayerName)
